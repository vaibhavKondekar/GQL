SELECT a.name AS author,
       b.title AS book,
       p.name AS publisher,
       city.name AS city,
       COUNT(b) AS bookCount,
       AVG(b.year) AS avgYear,
       MAX(b.year) AS latestYear
FROM MATCH (a:Author)-[:WROTE]->(b:Book),
     MATCH (b)-[:PUBLISHED_BY]->(p:Publisher),
     MATCH (a)-[:LIVES_IN]->(city:City)
WHERE b.year > 2000 AND p.country = "USA" AND city.population > 1000000
GROUP BY a.name, b.title, p.name, city.name
HAVING COUNT(b) > 1 AND AVG(b.year) > 2010
ORDER BY bookCount DESC, latestYear DESC
LIMIT 30;
